version: '3.9'

# Automation & AI Stack
# - Pi-hole (DNS-based Ad Blocking)
# - Ollama (Local LLM Inference)
# - n8n (Workflow Automation)

networks:
  homelab_network:
    external: true

volumes:
  adguard_work:
  adguard_conf:
  ollama_data:
  n8n_data:

services:
  # =========================================================================
  # ADGUARD HOME - Network-wide Ad Blocking with DNS-over-HTTPS/TLS/QUIC
  # =========================================================================
  adguardhome:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    hostname: adguardhome
    restart: unless-stopped
    networks:
      - homelab_network
    ports:
      - "53:53/tcp"      # DNS
      - "53:53/udp"      # DNS
      - "3000:3000/tcp"  # Initial Setup Wizard
      - "8053:80/tcp"    # Web Interface (match Pi-hole port)
      - "443:443/tcp"    # HTTPS
      - "853:853/tcp"    # DNS-over-TLS
    environment:
      - TZ=${TZ}
    volumes:
      - adguard_work:/opt/adguardhome/work
      - adguard_conf:/opt/adguardhome/conf
    cap_add:
      - NET_ADMIN
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adguard.rule=Host(`dns.${DOMAIN}`)"
      - "traefik.http.routers.adguard.entrypoints=websecure"
      - "traefik.http.routers.adguard.tls.certresolver=cloudflare"
      - "traefik.http.routers.adguard.middlewares=authentik@file"
      - "traefik.http.services.adguard.loadbalancer.server.port=80"

  # =========================================================================
  # OLLAMA - Local LLM Inference Engine
  # =========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    networks:
      - homelab_network
    ports:
      - "11434:11434"  # Ollama API
    environment:
      - TZ=${TZ}
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
    volumes:
      - ollama_data:/root/.ollama
    # Optional: GPU support (requires NVIDIA GPU + nvidia-docker2)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=Host(`ollama.${DOMAIN}`)"
      - "traefik.http.routers.ollama.entrypoints=websecure"
      - "traefik.http.routers.ollama.tls.certresolver=cloudflare"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
      - "traefik.http.routers.ollama.middlewares=authentik@file"

  # =========================================================================
  # OLLAMA WEB UI - Browser Interface for Ollama
  # =========================================================================
  ollama-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: ollama-webui
    restart: unless-stopped
    networks:
      - homelab_network
    ports:
      - "8081:8080"  # Changed from 8080 to avoid conflict with Traefik dashboard
    environment:
      - TZ=${TZ}
      - OLLAMA_API_BASE_URL=http://ollama:11434/api
      - WEBUI_AUTH=false  # Authentik handles auth
    volumes:
      - ollama_data:/app/backend/data
    depends_on:
      - ollama
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama-webui.rule=Host(`ai.${DOMAIN}`)"
      - "traefik.http.routers.ollama-webui.entrypoints=websecure"
      - "traefik.http.routers.ollama-webui.tls.certresolver=cloudflare"
      - "traefik.http.services.ollama-webui.loadbalancer.server.port=8080"
      - "traefik.http.routers.ollama-webui.middlewares=authentik@file"

  # =========================================================================
  # N8N - Workflow Automation Platform
  # =========================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    networks:
      - homelab_network
    ports:
      - "5678:5678"
    environment:
      - TZ=${TZ}
      - N8N_HOST=n8n.${DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.${DOMAIN}
      - GENERIC_TIMEZONE=${TZ}
      # Authentication via Authentik
      - N8N_DISABLE_UI=false
      # Database (optional - uses SQLite by default)
      # - DB_TYPE=postgresdb
      # - DB_POSTGRESDB_HOST=postgresql
      # - DB_POSTGRESDB_PORT=5432
      # - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME}
      # - DB_POSTGRESDB_USER=${POSTGRES_USER}
      # - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - n8n_data:/home/node/.n8n
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.${DOMAIN}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=cloudflare"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "traefik.http.routers.n8n.middlewares=authentik@file"
