---
# Bootstrap Playbook - Initial Proxmox Host Setup
# Usage: ansible-playbook -i ../inventory/hosts.yml 00-bootstrap.yml

- name: Bootstrap Proxmox Homelab Infrastructure
  hosts: proxmox_hosts
  become: yes
  gather_facts: yes

  vars:
    system_packages:
      - vim
      - git
      - curl
      - wget
      - htop
      - net-tools
      - ufw
      - fail2ban
      - rsync
      - ncdu
      - tree

  tasks:
    - name: Display host information
      debug:
        msg: "Bootstrapping {{ inventory_hostname }} ({{ ansible_host }})"

    - name: Ensure Debian repositories are configured
      apt_repository:
        repo: "{{ item }}"
        state: present
      loop:
        - "deb http://deb.debian.org/debian trixie main contrib non-free"
        - "deb http://security.debian.org/debian-security trixie-security main contrib"

    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Install system packages
      apt:
        name: "{{ system_packages }}"
        state: present

    - name: Set timezone
      timezone:
        name: "{{ timezone }}"

    - name: Configure UFW firewall - Set default policies
      ufw:
        state: enabled
        policy: deny
        direction: incoming

    - name: Configure UFW firewall - Allow outgoing
      ufw:
        direction: outgoing
        policy: allow

    - name: Configure UFW firewall - Allow specific ports
      ufw:
        rule: "{{ item.rule }}"
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: 22, proto: tcp, rule: allow, comment: 'SSH' }
        - { port: 80, proto: tcp, rule: allow, comment: 'HTTP' }
        - { port: 443, proto: tcp, rule: allow, comment: 'HTTPS' }
        - { port: 8006, proto: tcp, rule: allow, comment: 'Proxmox Web UI' }
        - { port: 2377, proto: tcp, rule: allow, comment: 'Docker Swarm management' }
        - { port: 7946, proto: tcp, rule: allow, comment: 'Docker Swarm communication TCP' }
        - { port: 7946, proto: udp, rule: allow, comment: 'Docker Swarm communication UDP' }
        - { port: 4789, proto: udp, rule: allow, comment: 'Docker overlay network' }

    - name: Enable UFW
      ufw:
        state: enabled

    - name: Create swap file
      command: fallocate -l 4G /swapfile
      args:
        creates: /swapfile

    - name: Set swap file permissions
      file:
        path: /swapfile
        mode: '0600'

    - name: Make swap
      command: mkswap /swapfile
      when: ansible_swaptotal_mb == 0

    - name: Enable swap
      command: swapon /swapfile
      when: ansible_swaptotal_mb == 0

    - name: Add swap to fstab
      lineinfile:
        path: /etc/fstab
        line: '/swapfile none swap sw 0 0'
        state: present

    - name: Set swappiness
      sysctl:
        name: vm.swappiness
        value: '10'
        state: present

    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ ansible_host }} {{ inventory_hostname }}"
        state: present

    - name: Configure SSH - Disable password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
      notify: Restart SSH

    - name: Configure SSH - Set PermitRootLogin
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin prohibit-password'
        state: present
      notify: Restart SSH

    - name: Install Python Docker SDK
      apt:
        name:
          - python3-docker
          - python3-pip
        state: present

    - name: Create directory for custom scripts
      file:
        path: /opt/homelab/scripts
        state: directory
        mode: '0755'

    - name: Display completion message
      debug:
        msg: "Bootstrap completed for {{ inventory_hostname }}"

  handlers:
    - name: Restart SSH
      service:
        name: sshd
        state: restarted
