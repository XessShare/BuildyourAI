name: HexaHub MVP Deployment

on:
  push:
    branches: [master, main, sprint-26/**]
    paths:
      - 'hexahub-backend/**'
      - 'hexahub-frontend/**'
      - '.github/workflows/hexahub-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  WEBHOOK_URL: ${{ secrets.RTX1080_WEBHOOK_URL }}
  STAGING_HOST: '192.168.17.1'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.RTX1080_WEBHOOK_URL }}" ]; then
            echo "‚ùå RTX1080_WEBHOOK_URL secret not set"
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Deploy to RTX1080 (Staging)
        id: deploy
        run: |
          MAX_RETRIES=3
          BACKOFF=5

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "üöÄ Deployment attempt $attempt/$MAX_RETRIES"

            RESPONSE=$(curl -X POST ${{ secrets.RTX1080_WEBHOOK_URL }} \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Event: deployment" \
              -d '{
                "service": "hexahub-backend",
                "commit": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}",
                "environment": "${{ github.event.inputs.environment || 'staging' }}",
                "actor": "${{ github.actor }}",
                "rollback": false
              }' \
              -w "\n%{http_code}" -s || echo "000")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Deployment webhook successful"
              break
            fi

            if [ $attempt -lt $MAX_RETRIES ]; then
              WAIT_TIME=$((BACKOFF * (2 ** (attempt - 1))))
              echo "‚è≥ Waiting ${WAIT_TIME}s before retry..."
              sleep $WAIT_TIME
            else
              echo "‚ùå Deployment failed after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Health check
        run: |
          echo "üîç Checking deployment health..."
          MAX_WAIT=15
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if curl -f -s http://${{ env.STAGING_HOST }}:8001/api/health > /dev/null; then
              echo "‚úÖ HexaHub backend is healthy!"
              curl -s http://${{ env.STAGING_HOST }}:8001/api/health | jq .
              exit 0
            fi

            echo "‚è≥ Waiting for service... ($ELAPSED/${MAX_WAIT}min)"
            sleep 10
            ELAPSED=$((ELAPSED + 1))
          done

          echo "‚ùå Health check timeout after ${MAX_WAIT} minutes"
          exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          echo "üîÑ Triggering rollback..."
          curl -X POST ${{ secrets.RTX1080_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "service": "hexahub-backend",
              "rollback": true,
              "reason": "Health check failed"
            }'

  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "üîó Backend: http://${{ env.STAGING_HOST }}:8001"
            echo "üìö API Docs: http://${{ env.STAGING_HOST }}:8001/api/docs"
          else
            echo "‚ùå Deployment failed!"
          fi
