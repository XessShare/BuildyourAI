name: Deploy to Homelab

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  WEBHOOK_URL: ${{ secrets.VPS_WEBHOOK_URL }}
  DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
  HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Validate secrets
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "‚ùå Error: VPS_WEBHOOK_URL secret not set"
            exit 1
          fi
          if [ -z "$DEPLOY_TOKEN" ]; then
            echo "‚ùå Error: DEPLOY_TOKEN secret not set"
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Trigger VPS Webhook (with retry)
        id: trigger-webhook
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          echo "üöÄ Triggering deployment to $ENVIRONMENT"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

          # Retry logic with exponential backoff
          max_attempts=3
          attempt=1
          backoff=5

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."

            response=$(curl -X POST "$WEBHOOK_URL" \
              -H "Authorization: Bearer $DEPLOY_TOKEN" \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Event: workflow_dispatch" \
              -d "{
                \"commit_hash\": \"${{ github.sha }}\",
                \"environment\": \"$ENVIRONMENT\",
                \"rollback_on_failure\": true,
                \"triggered_by\": \"github-actions\",
                \"branch\": \"${{ github.ref_name }}\",
                \"actor\": \"${{ github.actor }}\"
              }" \
              --max-time 30 \
              --fail \
              --silent \
              --show-error \
              --write-out "\nHTTP_CODE:%{http_code}" \
              2>&1)

            http_code=$(echo "$response" | grep "HTTP_CODE" | cut -d':' -f2)

            if [ "$http_code" = "200" ] || [ "$http_code" = "202" ]; then
              echo "‚úÖ Webhook triggered successfully (HTTP $http_code)"
              echo "Response: $(echo "$response" | grep -v "HTTP_CODE")"
              exit 0
            else
              echo "‚ö†Ô∏è  Attempt $attempt failed (HTTP $http_code)"
              echo "Response: $(echo "$response" | grep -v "HTTP_CODE")"

              if [ $attempt -lt $max_attempts ]; then
                echo "Retrying in ${backoff}s..."
                sleep $backoff
                backoff=$((backoff * 2))
              fi
            fi

            attempt=$((attempt + 1))
          done

          echo "‚ùå All webhook attempts failed"
          exit 1

      - name: Wait for deployment
        id: wait-deployment
        timeout-minutes: 15
        run: |
          echo "‚è≥ Waiting for deployment to complete..."

          max_wait=900  # 15 minutes
          interval=10   # Check every 10 seconds
          elapsed=0

          while [ $elapsed -lt $max_wait ]; do
            echo "Checking deployment status ($elapsed/${max_wait}s)..."

            # Health check
            if [ -n "$HEALTH_CHECK_URL" ]; then
              if curl -f --max-time 10 "$HEALTH_CHECK_URL" -s > /dev/null 2>&1; then
                echo "‚úÖ Deployment healthy!"
                exit 0
              fi
            else
              # Fallback: just wait a reasonable time
              if [ $elapsed -ge 180 ]; then  # 3 minutes minimum
                echo "‚ö†Ô∏è  Health check URL not configured, assuming success after 3min"
                exit 0
              fi
            fi

            sleep $interval
            elapsed=$((elapsed + interval))
          done

          echo "‚ùå Deployment did not become healthy within ${max_wait}s"
          exit 1

      - name: Deployment success notification
        if: success()
        run: |
          echo "üéâ Deployment successful!"
          echo "Environment: ${{ steps.set-env.outputs.environment }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Environment: ${{ steps.set-env.outputs.environment }}"
          echo "Commit: ${{ github.sha }}"
          echo "Check logs for details"

      - name: Trigger rollback on failure
        if: failure() && steps.wait-deployment.outcome == 'failure'
        run: |
          echo "üîÑ Triggering automatic rollback..."

          curl -X POST "$WEBHOOK_URL" \
            -H "Authorization: Bearer $DEPLOY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"action\": \"rollback\",
              \"commit_hash\": \"${{ github.sha }}\",
              \"environment\": \"${{ steps.set-env.outputs.environment }}\",
              \"reason\": \"deployment_failed\"
            }" \
            --max-time 30 \
            --fail \
            || echo "‚ö†Ô∏è  Rollback trigger failed - manual intervention required"

  # Security scan job (runs in parallel)
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security scan
        run: |
          echo "üîí Running security checks..."

          # Check for secrets in code (basic check)
          if grep -r "API_KEY\|SECRET\|PASSWORD" --include="*.py" --include="*.yml" . | grep -v ".env" | grep -v "test"; then
            echo "‚ö†Ô∏è  Warning: Potential secrets found in code"
          else
            echo "‚úÖ No obvious secrets found"
          fi

  # Notification job (runs after deployment)
  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()

    steps:
      - name: Send notification
        run: |
          status="${{ needs.deploy.result }}"

          if [ "$status" = "success" ]; then
            emoji="‚úÖ"
            message="Deployment successful"
          else
            emoji="‚ùå"
            message="Deployment failed"
          fi

          echo "$emoji $message"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"

          # Add Telegram/Slack notification here if configured
          # if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          #   curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          #     -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          #     -d "text=$emoji J-Jeco Deployment: $message"
          # fi
